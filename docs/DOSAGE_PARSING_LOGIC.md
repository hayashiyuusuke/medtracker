# 📘 服用回数解析ロジックのドキュメント

## 🎯 概要

QRコードから読み取った服用方法の文字列を解析し、1日の服用回数を正確に抽出するロジックです。

## 🔍 解析パターン

### パターン1: 「毎食」キーワード → 3回

```javascript
"毎食後" → 3回
"毎食前" → 3回
"毎食時" → 3回
```

**正規表現**: `/毎食/`

**理由**: 毎食 = 朝昼晩の3食

---

### パターン2: 「朝昼晩」のパターン → 3回

```javascript
"朝昼晩食後" → 3回
"朝・昼・晩" → 3回
"朝昼夕食後" → 3回
"朝昼夜" → 3回
```

**正規表現**: `/朝.*昼.*晩|朝.*昼.*夕|朝.*昼.*夜/`

**説明**:
- `朝.*昼.*晩`: 「朝」の後に「昼」、その後に「晩」がある
- `.*`: 任意の文字が0文字以上（間に何があってもOK）
- `|`: または（OR条件）

---

### パターン3: 「朝晩」のパターン → 2回

```javascript
"朝晩食後" → 2回
"朝夕" → 2回
"朝夜" → 2回
```

**正規表現**: `/朝.*[晩夕夜]/`

**説明**:
- `朝.*[晩夕夜]`: 「朝」の後に「晩」「夕」「夜」のいずれか
- `[晩夕夜]`: 文字クラス（いずれか1文字）

---

### パターン4: 明示的な「〇回」表記

```javascript
"1日3回食後" → 3回
"1日2回朝晩" → 2回
"1日 1 回" → 1回（スペースがあっても可）
```

**正規表現**: `/(\d+)\s*回/`

**説明**:
- `(\d+)`: 1つ以上の数字（キャプチャグループ）
- `\s*`: 0文字以上の空白
- `回`: 文字「回」

**抽出方法**:
```javascript
const match = dosageText.match(/(\d+)\s*回/);
if (match) return parseFloat(match[1]); // match[1]がキャプチャした数字
```

---

### パターン5: 先頭の数字（フォールバック）

```javascript
"3食後" → 3回
"2錠ずつ" → 2回
"1回就寝前" → 1回
```

**正規表現**: `/\d+/`

**説明**: 最初に出現する連続した数字を取得

---

### デフォルト値

```javascript
"就寝前に服用" → 1回（デフォルト）
"症状に応じて" → 1回（デフォルト）
```

数字が全く見つからない場合は **1回** を返す

---

## 💻 実装コード

```typescript
// 服用回数を解析する関数
const parseFrequency = (dosageText: string): number => {
  // パターン1: 「毎食後」「毎食」→ 3回
  if (dosageText.match(/毎食/)) return 3;
  
  // パターン2: 「朝昼晩」「朝・昼・晩」→ 3回
  if (dosageText.match(/朝.*昼.*晩|朝.*昼.*夕|朝.*昼.*夜/)) return 3;
  
  // パターン3: 「朝晩」「朝夕」→ 2回
  if (dosageText.match(/朝.*[晩夕夜]/)) return 2;
  
  // パターン4: 「1日〇回」のような明示的な数字
  const match = dosageText.match(/(\d+)\s*回/);
  if (match) return parseFloat(match[1]);
  
  // パターン5: 先頭の数字（フォールバック）
  const firstNumber = dosageText.match(/\d+/)?.[0];
  if (firstNumber) return parseFloat(firstNumber);
  
  // デフォルト: 1回
  return 1;
};
```

---

## 🎨 使用例

```typescript
// QRコードから読み取った服用方法
const examples = [
  "毎食後",           // → 3回
  "朝昼晩食後",       // → 3回
  "朝晩食後",         // → 2回
  "1日3回食後",       // → 3回
  "1日2回朝夕",       // → 2回
  "1日1回就寝前",     // → 1回
  "就寝前に服用",     // → 1回（デフォルト）
];

examples.forEach(dosage => {
  const frequency = parseFrequency(dosage);
  console.log(`"${dosage}" → ${frequency}回`);
});
```

---

## 📊 優先順位

解析は**上から順番に**チェックされます：

1. 🥇 「毎食」キーワード
2. 🥈 「朝昼晩」パターン
3. 🥉 「朝晩」パターン
4. 4️⃣ 「〇回」明示的な表記
5. 5️⃣ 先頭の数字
6. 6️⃣ デフォルト（1回）

**重要**: 最初にマッチしたパターンで即座に値を返します。

---

## 🧪 テストケース

### ✅ 成功ケース

| 入力 | 期待値 | 実際の値 | 備考 |
|------|--------|----------|------|
| `毎食後` | 3 | 3 | パターン1 |
| `朝昼晩食後` | 3 | 3 | パターン2 |
| `朝晩` | 2 | 2 | パターン3 |
| `1日3回` | 3 | 3 | パターン4 |
| `1日 2 回` | 2 | 2 | パターン4（スペースあり） |
| `3食後` | 3 | 3 | パターン5 |
| `就寝前` | 1 | 1 | デフォルト |

### ⚠️ エッジケース

| 入力 | 結果 | 説明 |
|------|------|------|
| `1日3回毎食後` | 3 | 「毎食」が優先される |
| `朝昼晩1日2回` | 3 | 「朝昼晩」パターンが優先 |
| `朝1錠晩2錠` | 2 | 「朝晩」パターン適用 |
| `症状に応じて1~2回` | 1 | 最初の数字'1'を取得 |

---

## 🔧 今後の拡張案

### 1. より細かいパターン追加

```typescript
// 「朝昼」→ 2回
if (dosageText.match(/朝.*昼(?!.*[晩夕夜])/)) return 2;

// 「昼晩」→ 2回
if (dosageText.match(/昼.*[晩夕夜](?!.*朝)/)) return 2;
```

### 2. 範囲指定の対応

```typescript
// 「1日1~2回」→ 平均値1.5または最小値1
const rangeMatch = dosageText.match(/(\d+)~(\d+)回/);
if (rangeMatch) {
  const min = parseFloat(rangeMatch[1]);
  const max = parseFloat(rangeMatch[2]);
  return (min + max) / 2; // または min を返す
}
```

### 3. 英語表記の対応

```typescript
// "3 times a day" → 3回
if (dosageText.match(/(\d+)\s*times?\s*(a|per)\s*day/i)) {
  const match = dosageText.match(/(\d+)/);
  return parseFloat(match[1]);
}
```

---

## 🐛 既知の制限事項

1. **「1日3回」vs「朝昼晩」の重複**
   - 両方含む場合、「毎食」または「朝昼晩」が優先される
   - 例: `"1日3回朝昼晩食後"` → 3回（問題なし）

2. **複雑な条件文**
   - `"朝1錠、昼2錠、晩1錠"` → 2回（「朝晩」パターン）
   - 実際の回数は3回だが、パターンマッチの限界

3. **特殊なケース**
   - `"4時間ごと"` → 認識できない（デフォルト1回）
   - `"必要時"` → 認識できない（デフォルト1回）

---

## 📚 関連ドキュメント

- [正規表現リファレンス](https://developer.mozilla.org/ja/docs/Web/JavaScript/Guide/Regular_Expressions)
- [String.prototype.match()](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/String/match)
- [parseFloat() リファレンス](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/parseFloat)

---

## ✅ まとめ

この解析ロジックにより、以下が実現できます：

- ✅ 「毎食後」を正しく3回と認識
- ✅ 「朝晩」を正しく2回と認識
- ✅ 明示的な「〇回」表記を正確に抽出
- ✅ 数字が見つからない場合も安全にデフォルト値を返す
- ✅ 総数の計算も正確に（用量 × 回数 × 日数）

これで、ユーザーがQRコードをスキャンした際に、より正確な服用回数が自動入力されるようになりました！🎉
